<template>
  <div id="giscus-container"></div>
</template>

<script lang="ts" setup>
import { useData, useRoute } from 'vitepress'
import giscusTalk from 'vitepress-plugin-comment-with-giscus'
import { computed, onUnmounted, watch } from 'vue'

const { frontmatter, isDark } = useData()
const route = useRoute()

const giscusTheme = computed(() => {
  return isDark.value ? 'dark' : 'light'
})

// TODO: repo等資訊 應該要由config傳入
const giscusConfig = {
  repo: 'evadzala/evadzala.github.io',
  repoId: 'R_kgDOIfJpug',
  category: 'Announcements',
  categoryId: 'DIC_kwDOIfJpus4Ctk3i',
  mapping: 'pathname',
  lang: 'en',
  strict: '0',
  reactionsEnabled: '1',
  emitMetadata: '1',
  theme: giscusTheme.value,
  loading: 'lazy',
  crossorigin: 'anonymous',
  async: true,
}

giscusTalk(
  giscusConfig,
  {
    frontmatter,
    route,
  },
  true,
)

onUnmounted(() => {
  const container = document.getElementById('giscus-container')
  if (container) {
    container.innerHTML = ''
  }

  const giscusIframes = document.querySelectorAll('iframe[src*="giscus"]')
  giscusIframes.forEach(iframe => iframe.remove())

  const scripts = document.querySelectorAll('script[src*="giscus"]')
  scripts.forEach(script => script.remove())

  const giscusElements = document.querySelectorAll(
    '[class*="giscus"], [id*="giscus"]',
  )
  giscusElements.forEach(element => {
    if (element.id !== 'giscus-container') {
      element.remove()
    }
  })
})

watch(giscusTheme, newTheme => {
  const iframe = document.querySelector('#giscus-container iframe')
  if (iframe?.contentWindow) {
    iframe.contentWindow.postMessage(
      {
        giscus: {
          setConfig: {
            theme: newTheme,
          },
        },
      },
      'https://giscus.app',
    )
  }
})
</script>
